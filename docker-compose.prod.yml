# =============================================================================
# Docker Compose - Production Environment (FrankenPHP)
# Sanapati - Sistem Informasi Arsip Digital
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # FrankenPHP Application (Production with Worker Mode)
  # ---------------------------------------------------------------------------
  app:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: arsip-app-prod
    restart: always
    ports:
      - "${APP_PORT:-80}:80"
      - "443:443"
      - "443:443/udp" # HTTP/3
    volumes:
      - laravel-storage:/app/storage
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - arsip-network
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      APP_ENV: production
      APP_DEBUG: "false"
      RUN_MIGRATIONS: "true"
      SERVER_NAME: "${SERVER_NAME:-:80}"
      FRANKENPHP_CONFIG: "worker ./public/index.php"
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-arsip_digital}
      DB_USERNAME: ${DB_USERNAME:-arsip}
      DB_PASSWORD: ${DB_PASSWORD}
      # Cache & Session (file/database based)
      CACHE_DRIVER: file
      SESSION_DRIVER: database
      QUEUE_CONNECTION: database
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/health" ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

  # ---------------------------------------------------------------------------
  # MySQL Database (Production)
  # ---------------------------------------------------------------------------
  mysql:
    image: mysql:8.0
    container_name: arsip-mysql-prod
    restart: always
    environment:
      MYSQL_DATABASE: ${DB_DATABASE:-arsip_digital}
      MYSQL_USER: ${DB_USERNAME:-arsip}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    volumes:
      - mysql-data-prod:/var/lib/mysql
    networks:
      - arsip-network
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M

  # ---------------------------------------------------------------------------
  # Laravel Queue Worker
  # ---------------------------------------------------------------------------
  queue:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: arsip-queue-prod
    restart: always
    working_dir: /app
    volumes:
      - laravel-storage:/app/storage
    networks:
      - arsip-network
    depends_on:
      app:
        condition: service_healthy
    environment:
      APP_ENV: production
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-arsip_digital}
      DB_USERNAME: ${DB_USERNAME:-arsip}
      DB_PASSWORD: ${DB_PASSWORD}
      QUEUE_CONNECTION: database
    entrypoint: []
    command: php artisan queue:work --sleep=3 --tries=3 --max-time=3600
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M

  # ---------------------------------------------------------------------------
  # Laravel Scheduler
  # ---------------------------------------------------------------------------
  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: arsip-scheduler-prod
    restart: always
    working_dir: /app
    volumes:
      - laravel-storage:/app/storage
    networks:
      - arsip-network
    depends_on:
      app:
        condition: service_healthy
    environment:
      APP_ENV: production
      DB_CONNECTION: mysql
      DB_HOST: mysql
      DB_PORT: 3306
      DB_DATABASE: ${DB_DATABASE:-arsip_digital}
      DB_USERNAME: ${DB_USERNAME:-arsip}
      DB_PASSWORD: ${DB_PASSWORD}
    entrypoint: []
    command: sh -c "while true; do php artisan schedule:run --verbose --no-interaction & sleep 60; done"
    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M

# =============================================================================
# Networks
# =============================================================================
networks:
  arsip-network:
    driver: bridge

# =============================================================================
# Volumes
# =============================================================================
volumes:
  mysql-data-prod:
    driver: local
  laravel-storage:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
